<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ include file="/common/common.jsp" %>
<%
// 메뉴 접근권한 체크
if(!Site.isPmss(out,"sheet","")) return;

Db db = null;

try {
	// DB Connection
	db = new Db(true);

	// get parameter
	String sheet_code = CommonUtil.getParameter("sheet_code");

	// 파라미터 체크
	if(!CommonUtil.hasText(sheet_code)) {
		out.print(CommonUtil.getPopupMsg(CommonUtil.getErrorMsg("NO_PARAM"),"","close"));
		return;
	}

	String sheet_name = "";
	Map<String, Object> cpmap = new LinkedHashMap();
	Map<String, Object> camap = new LinkedHashMap();
	Map<String, Object> itmap = new LinkedHashMap();

	List<Map<String, Object>> list = db.selectList("sheet.sheetView", sheet_code);
	if (list.size()>0){
		sheet_name = list.get(0).get("sheet_name").toString();
	}
	else{
		ComLib.viewMessage(out,"해당 시트가 존재하지 않습니다.("+sheet_code+")",true);
		return;
	}
	for(Map<String, Object> item : list) {
		// 부모 카테고리 건수
		cpmap.put(item.get("cate_pcode").toString(), Integer.parseInt(ComLib.toNN(cpmap.get(item.get("cate_pcode")),"0").toString())+1);
		// 자식 카테고리 건수
		camap.put(item.get("cate_code").toString(), Integer.parseInt(ComLib.toNN(camap.get(item.get("cate_code")),"0").toString())+1);
		// 평가 항목 건수
		itmap.put(item.get("item_code").toString(), Integer.parseInt(ComLib.toNN(itmap.get(item.get("item_code")),"0").toString())+1);
	}

	// header 설정
	response.reset();
	response.setHeader("Content-type","application/vnd.ms-excel; charset=euc_kr");
	response.setHeader("Content-Description","Generated By CREC");
	response.setHeader("Content-Disposition","attachment; filename = " + java.net.URLEncoder.encode("평가시트_" + sheet_name + "_" + DateUtil.getToday("yyyy-MM-dd") + ".xls", "UTF-8"));
	response.setHeader("Pragma","no-cache");
	response.setHeader("Expires","0");
	response.setHeader("Cache-Control","max-age=0");

	String htmSheetBody = "";
	int cp_idx=0, ca_idx=0, it_idx=0, n=0;

	for(Map<String, Object> item : list) {
		htmSheetBody += "<tr>\n";
		if(cp_idx<1) {
			htmSheetBody += "<td rowspan='" + cpmap.get(item.get("cate_pcode")) + "'>" + item.get("cate_pname") + "</td>\n";
			cp_idx = Integer.parseInt(cpmap.get(item.get("cate_pcode")).toString())-1;
		} else {
			cp_idx--;
		}

		if(ca_idx<1) {
			htmSheetBody += "<td rowspan='" + camap.get(item.get("cate_code")) + "'>" + item.get("cate_name") + "</td>\n";
			ca_idx = Integer.parseInt(camap.get(item.get("cate_code")).toString())-1;
		} else {
			ca_idx--;
		}

		if(it_idx<1) {
			htmSheetBody += "<td rowspan='" + itmap.get(item.get("item_code")) + "'>" + item.get("item_name") + "</td>\n";
			it_idx = Integer.parseInt(itmap.get(item.get("item_code")).toString())-1;
			n++;
		} else {
			it_idx--;
		}

		htmSheetBody +=
			"<td>" + item.get("exam_name") + "</td>\n"+
			"<td>" + item.get("exam_score") + "</td>\n"+
			"<td>" + item.get("add_score") + "</td>\n"+
			"<td align=center>" + ((item.get("default_yn").equals("y")) ? "O" : "") + "</td>\n"+
			"</tr>\n";
	}

%>
<meta http-equiv='Content-Type' content='application/vnd.ms-excel;charset=euc-kr'>
<style>.th {background-color:#E4E4E4 !important;font-weight:bold}; .title {font-weight:bold;font-size:18px}</style>

<body>
<div class=title>시트명 : <%=sheet_name%></div>
<table border='1' cellpadding='0' cellspacing='0' bordercolor='#BBBBBB'>
	<thead>
		<tr><th class=th colspan="2" style="width:22%;">카테고리</th>
			<th class=th>항목</th>
			<th class=th>보기</th>
			<th class=th>배점</th>
			<th class=th>가중치</th>
			<th class=th>기본선택</th>
		</tr>
	</thead>
	<tbody>
	<%=htmSheetBody%>
	</tbody>
</table>
</body>

</html>
<%
} catch(Exception e) {
	logger.error(e.getMessage());
} finally {
	if(db!=null) db.close();
}
%>